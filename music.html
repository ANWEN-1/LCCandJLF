<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„éšèº«å¬</title>
    <style>
        /* === 1. æ˜¼å¤œåˆ‡æ¢å¼€å…³æ ·å¼ (ä¿æŒä¸å˜) === */
        .toggle-wrapper {
            position: fixed;
            top: 30px;
            right: 70px;
            transform: scale(0.4);
            transform-origin: top right;
            z-index: 1000;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-label {
            width: 180px;
            height: 80px;
            background-color: #87CEEB;
            border-radius: 80px;
            position: relative;
            cursor: pointer;
            display: block;
            overflow: hidden;
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 -4px 8px rgba(255, 255, 255, 0.8), 0 8px 15px rgba(0, 0, 0, 0.1);
            border: 6px solid #dbe4ef;
            transition: background-color 0.5s ease;
        }

        .background-day {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: 0.5s;
        }

        .cloud {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0.9;
        }

        .cloud-1 {
            width: 60px;
            height: 60px;
            left: 60px;
            bottom: -30px;
        }

        .cloud-2 {
            width: 50px;
            height: 50px;
            left: 90px;
            bottom: -20px;
            z-index: 2;
        }

        .cloud-3 {
            width: 70px;
            height: 70px;
            right: 10px;
            bottom: -35px;
        }

        .cloud-4 {
            width: 40px;
            height: 40px;
            right: 60px;
            bottom: -15px;
            opacity: 0.7;
        }

        .background-night {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, #1a2340, #2b324d);
            opacity: 0;
            transform: translateX(-100%);
            transition: 0.5s;
        }

        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }

        .star-1 {
            width: 8px;
            height: 8px;
            top: 20px;
            left: 40px;
        }

        .star-2 {
            width: 6px;
            height: 6px;
            top: 45px;
            left: 70px;
        }

        .star-3 {
            width: 5px;
            height: 5px;
            top: 15px;
            left: 90px;
        }

        .dot {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            opacity: 0.6;
        }

        .dot-1 {
            width: 3px;
            height: 3px;
            top: 50px;
            left: 20px;
        }

        .dot-2 {
            width: 2px;
            height: 2px;
            top: 30px;
            left: 60px;
        }

        .toggle-button {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 68px;
            height: 68px;
            border-radius: 50%;
            background: #FFD54F;
            box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.1), 0 2px 5px rgba(0, 0, 0, 0.2), 0 0 10px 2px rgba(253, 216, 53, 0.4);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 10;
            overflow: hidden;
        }

        .crater {
            position: absolute;
            background-color: #9aa7b5;
            border-radius: 50%;
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: 0.3s;
        }

        .crater-1 {
            width: 20px;
            height: 20px;
            top: 10px;
            left: 25px;
        }

        .crater-2 {
            width: 10px;
            height: 10px;
            top: 40px;
            left: 15px;
        }

        .crater-3 {
            width: 8px;
            height: 8px;
            top: 35px;
            left: 45px;
        }

        .toggle-checkbox:checked+.toggle-label .toggle-button {
            transform: translateX(100px);
            background: #eef2f5;
            box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.1), 0 2px 5px rgba(0, 0, 0, 0.3), 0 0 15px 3px rgba(255, 255, 255, 0.4);
        }

        .toggle-checkbox:checked+.toggle-label .toggle-button .crater {
            opacity: 1;
        }

        .toggle-checkbox:checked+.toggle-label .background-day {
            transform: translateY(100%);
            opacity: 0;
        }

        .toggle-checkbox:checked+.toggle-label .background-night {
            transform: translateX(0);
            opacity: 1;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #1a2340;
            border-color: #576075;
        }

        /* === 2. æ’­æ”¾åˆ—è¡¨æœç´¢æ¡† === */
        .playlist-search {
            padding: 0 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
        }

        .playlist-search input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
            transition: 0.3s;
        }

        .playlist-search input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* === 3. åŸºç¡€è®¾ç½® & æ˜¼å¤œæ ¸å¿ƒä¿®æ”¹ === */
        body {
            margin: 0;
            padding: 0;
            font-family: 'PingFang SC', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            background: #666;
            transition: background 0.5s;
        }

        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(40px) brightness(1.1) saturate(1.2);
            z-index: 1;
            transform: scale(1.1);
            transition: background-image 0.5s, filter 0.5s;
        }

        body.dark-mode {
            background-color: #000 !important;
        }

        body.dark-mode .bg-layer {
            filter: blur(40px) brightness(0.3) saturate(0.8) !important;
        }

        body.dark-mode .playlist-drawer {
            background: rgba(0, 0, 0, 0.95);
        }

        /* === 4. ç•Œé¢å¸ƒå±€ === */
        .container {
            position: relative;
            z-index: 10;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .info-side {
            flex: 1;
            padding-right: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .tag {
            font-size: 16px;
            letter-spacing: 2px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        h1.title {
            font-size: 64px;
            margin: 0;
            font-weight: bold;
            line-height: 1.2;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        h2.artist {
            font-size: 32px;
            margin: 10px 0 40px 0;
            font-weight: 500;
            opacity: 0.9;
        }

        .current-lyric {
            font-size: 24px;
            font-weight: 300;
            opacity: 0.8;
            min-height: 40px;
            margin-bottom: 40px;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .control-bar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 500px;
        }

        .progress-area {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        input[type=range] {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
        }

        .buttons {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-top: 10px;
        }

        .btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: scale(1.1);
            text-shadow: 0 0 10px white;
        }

        .btn-main {
            width: 60px;
            height: 60px;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 24px;
        }

        .btn-side {
            font-size: 30px;
            opacity: 0.8;
        }

        /* === å³ä¾§å°é¢ & è§†é¢‘å®¹å™¨ === */
        .cover-side {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            position: relative;
        }

        /* ä¸“è¾‘å°é¢ (MP3æ¨¡å¼) - è‡ªé€‚åº”ç‰ˆ */
        .album-art {
            /* 2. è®¾å®šæœ€å¤§é™åˆ¶ (é˜²æ­¢å›¾ç‰‡å¤ªå¤§ç›–ä½æ­Œè¯) */
            max-width: 450px;
            max-height: 450px;

            /* 3. è®©å®½é«˜è‡ªåŠ¨æ ¹æ®å›¾ç‰‡åŸæœ¬çš„æ¯”ä¾‹ç¼©æ”¾ */
            width: auto;
            height: auto;

            /* 4. ä¿æŒå›¾ç‰‡å®Œæ•´ï¼Œä¸è£å‰ª */
            object-fit: contain;

            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: transform 0.5s;
            z-index: 2;
        }

        .playing .album-art {
            transform: scale(1.02);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
        }

        /* è§†é¢‘æ’­æ”¾å™¨ (MVæ¨¡å¼) - è‡ªé€‚åº”ç‰ˆ */
        .video-player {
            /* 2. æ”¹ä¸ºé™åˆ¶æœ€å¤§å®½é«˜ï¼Œé˜²æ­¢è§†é¢‘å¤ªå¤§æ’‘ç ´é¡µé¢ */
            max-width: 450px;
            max-height: 450px;

            /* 3. è®©å®½é«˜è‡ªåŠ¨é€‚åº”å†…å®¹ */
            width: auto;
            height: auto;

            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);

            /* 4. å»æ‰é»‘è‰²èƒŒæ™¯ï¼Œæ”¹ä¸ºé€æ˜ */
            background: transparent;

            display: none;
            z-index: 3;
        }

        .playlist-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            z-index: 100;
            transition: 0.4s ease;
            padding: 20px;
            box-sizing: border-box;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .playlist-drawer.open {
            right: 0;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .playlist-items {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .playlist-items li {
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .playlist-items li:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-items li.active {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-weight: bold;
        }

        .playlist-items li .song-idx {
            font-size: 12px;
            opacity: 0.5;
            margin-right: 10px;
        }

        .back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 20;
            color: white;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column-reverse;
                justify-content: center;
                text-align: center;
            }

            .info-side {
                padding-right: 0;
                align-items: center;
                margin-top: 30px;
            }

            .cover-side {
                justify-content: center;
                flex: none;
            }

            .album-art,
            .video-player {
                width: 280px;
                height: 280px;
            }

            h1.title {
                font-size: 32px;
            }

            .playlist-drawer {
                width: 80%;
                right: -100%;
            }

            .toggle-wrapper {
                top: 10px;
                right: 10px;
                transform: scale(0.3);
            }
        }
    </style>
</head>

<body>

    <div class="toggle-wrapper">
        <input type="checkbox" id="day-night-switch" class="toggle-checkbox">
        <label for="day-night-switch" class="toggle-label">
            <div class="background-night">
                <span class="star star-1"></span><span class="star star-2"></span><span class="star star-3"></span>
                <span class="dot dot-1"></span><span class="dot dot-2"></span>
            </div>
            <div class="background-day">
                <div class="cloud cloud-1"></div>
                <div class="cloud cloud-2"></div>
                <div class="cloud cloud-3"></div>
                <div class="cloud cloud-4"></div>
            </div>
            <div class="toggle-button">
                <span class="crater crater-1"></span><span class="crater crater-2"></span><span
                    class="crater crater-3"></span>
            </div>
        </label>
    </div>

    <div class="bg-layer" id="bg-layer"></div>
    <a href="index.html" class="back-btn">â† è¿”å›</a>

    <div class="container" id="player-container">
        <div class="info-side">
            <div class="tag">æˆ‘çš„ç²¾é€‰æ­Œå•</div>
            <h1 class="title" id="song-title">Loading...</h1>
            <h2 class="artist" id="song-artist">...</h2>
            <div class="current-lyric" id="current-lyric-line">å‡†å¤‡æ’­æ”¾...</div>

            <div class="control-bar">
                <div class="progress-area">
                    <span id="curr-time">00:00</span>
                    <input type="range" id="progress-bar" value="0" step="0.1">
                    <span id="total-time">00:00</span>
                </div>

                <div class="buttons">
                    <button class="btn btn-side" onclick="togglePlaylist()">ğŸ“œ</button>
                    <button class="btn btn-side" onclick="prevSong()">â®ï¸</button>
                    <button class="btn btn-main" id="play-btn">â–¶</button>
                    <button class="btn btn-side" onclick="nextSong()">â­ï¸</button>
                    <button class="btn btn-side" id="mode-btn" onclick="toggleMode()" title="åˆ‡æ¢æ’­æ”¾æ¨¡å¼">ğŸ”</button>
                </div>
            </div>
        </div>

        <div class="cover-side">
            <img src="" class="album-art" id="album-art">
            <video id="video-player" class="video-player" playsinline webkit-playsinline></video>
        </div>
    </div>

    <div class="playlist-drawer" id="playlist-drawer">
        <div class="drawer-header">
            <h3>æ’­æ”¾åˆ—è¡¨ (<span id="song-count">0</span>)</h3>
            <span style="cursor:pointer" onclick="togglePlaylist()">âœ•</span>
        </div>
        <div class="playlist-search">
            <input type="text" id="playlist-search-input" placeholder="ğŸ” æœç´¢æ­Œåæˆ–æ­Œæ‰‹...">
        </div>
        <ul class="playlist-items" id="playlist-box">
        </ul>
    </div>

    <audio id="audio-player"></audio>

    <script src="assets/js/theme.js"></script>

    <script>
        // è·å–æ‰€æœ‰æ ¸å¿ƒå…ƒç´ 
        const audioEl = document.getElementById('audio-player');
        const videoEl = document.getElementById('video-player');
        const imgEl = document.getElementById('album-art');

        const playBtn = document.getElementById('play-btn');
        const progressBar = document.getElementById('progress-bar');
        const bgLayer = document.getElementById('bg-layer');
        const lyricLine = document.getElementById('current-lyric-line');
        const playlistBox = document.getElementById('playlist-box');

        let playMode = 'loop';
        const modeBtn = document.getElementById('mode-btn');

        let songs = [];
        let currentIndex = 0;
        let lyricsData = [];

        // å…³é”®å˜é‡ï¼šå½“å‰æ­£åœ¨ä½¿ç”¨çš„æ’­æ”¾å™¨ï¼ˆaudioEl æˆ– videoElï¼‰
        let currentPlayer = audioEl;

        // 1. åˆå§‹åŒ–
        fetch('data/music.json')
            .then(res => res.json())
            .then(data => {
                songs = data;
                document.getElementById('song-count').innerText = songs.length;
                renderPlaylist();
                loadSong(0);
            });

        // 2. åŠ è½½æ­Œæ›²å‡½æ•°
        function loadSong(index) {
            // å…ˆæš‚åœå¹¶é‡ç½®ä¸¤ä¸ªæ’­æ”¾å™¨ï¼Œé˜²æ­¢å£°éŸ³é‡å 
            audioEl.pause();
            videoEl.pause();

            currentIndex = index;
            const song = songs[index];

            document.getElementById('song-title').innerText = song.title;
            document.getElementById('song-artist').innerText = song.artist;

            // èƒŒæ™¯å›¾å§‹ç»ˆç”¨å°é¢
            bgLayer.style.backgroundImage = `url(${song.cover})`;

            // === æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯ MP3 è¿˜æ˜¯ MP4 ===
            const isVideo = song.src.toLowerCase().endsWith('.mp4') || song.src.toLowerCase().endsWith('.webm');

            if (isVideo) {
                // åˆ‡æ¢åˆ°è§†é¢‘æ¨¡å¼
                currentPlayer = videoEl;
                imgEl.style.display = 'none';   // éšè—å°é¢
                videoEl.style.display = 'block'; // æ˜¾ç¤ºè§†é¢‘
                videoEl.src = song.src;
            } else {
                // åˆ‡æ¢åˆ°éŸ³é¢‘æ¨¡å¼
                currentPlayer = audioEl;
                videoEl.style.display = 'none'; // éšè—è§†é¢‘
                imgEl.style.display = 'block';  // æ˜¾ç¤ºå°é¢
                imgEl.src = song.cover;
                audioEl.src = song.src;
            }

            // åŠ è½½æ­Œè¯ (é€šç”¨é€»è¾‘)
            loadLyrics(song.lrc);

            // æ›´æ–°æ’­æ”¾åˆ—è¡¨é«˜äº®
            const searchInput = document.getElementById('playlist-search-input');
            if (searchInput) {
                renderPlaylist(searchInput.value);
            } else {
                renderPlaylist();
            }

            // è‡ªåŠ¨æ’­æ”¾
            if (playBtn.innerText === "â¸") {
                // å°è¯•æ’­æ”¾ï¼Œå¦‚æœæœ‰é”™è¯¯ä¼šè¢«å¤–é¢çš„ error handler æ•è·
                currentPlayer.play().catch(e => console.log("ç­‰å¾…äº¤äº’...", e));
                document.getElementById('player-container').classList.add('playing');
            } else {
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                playBtn.innerText = "â–¶";
                document.getElementById('player-container').classList.remove('playing');
            }
        }

        // è¾…åŠ©ï¼šåŠ è½½æ­Œè¯
        function loadLyrics(lrcSource) {
            lyricsData = [];
            lyricLine.innerText = "çº¯éŸ³ä¹ / æš‚æ— æ­Œè¯";

            if (!lrcSource) return;

            if (lrcSource.endsWith('.lrc')) {
                lyricLine.innerText = "æ­£åœ¨åŠ è½½æ­Œè¯...";
                fetch(lrcSource)
                    .then(res => res.ok ? res.text() : "")
                    .then(text => parseLyrics(text))
                    .catch(() => lyricLine.innerText = "æš‚æ— æ­Œè¯");
            } else {
                parseLyrics(lrcSource);
            }
        }

        // 3. æ’­æ”¾æ§åˆ¶ (æ§åˆ¶ currentPlayer)
        function togglePlay() {
            if (currentPlayer.paused) {
                currentPlayer.play();
                playBtn.innerText = "â¸";
                document.getElementById('player-container').classList.add('playing');
            } else {
                currentPlayer.pause();
                playBtn.innerText = "â–¶";
                document.getElementById('player-container').classList.remove('playing');
            }
        }
        playBtn.addEventListener('click', togglePlay);

        // ä¸‹ä¸€é¦–/ä¸Šä¸€é¦–
        function nextSong() {
            let newIndex;
            if (playMode === 'random') {
                newIndex = Math.floor(Math.random() * songs.length);
            } else {
                newIndex = currentIndex + 1;
                if (newIndex >= songs.length) newIndex = 0;
            }
            loadSong(newIndex);
            // ç¡®ä¿åˆ‡æ­ŒåæŒ‰é’®å˜ä¸ºæš‚åœçŠ¶æ€ï¼ˆè¡¨ç¤ºæ­£åœ¨æ’­æ”¾ï¼‰
            playBtn.innerText = "â¸";
            // æ’­æ”¾ï¼Œå¦‚æœå¤±è´¥ä¼šè§¦å‘ error
            currentPlayer.play().catch(e => { });
        }

        function prevSong() {
            let newIndex;
            if (playMode === 'random') {
                newIndex = Math.floor(Math.random() * songs.length);
            } else {
                newIndex = currentIndex - 1;
                if (newIndex < 0) newIndex = songs.length - 1;
            }
            loadSong(newIndex);
            playBtn.innerText = "â¸";
            currentPlayer.play().catch(e => { });
        }

        // === ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†å‡½æ•° ===
        function handleTimeUpdate(e) {
            // åªå“åº”å½“å‰æ’­æ”¾å™¨çš„äº‹ä»¶
            if (e.target !== currentPlayer) return;

            const percent = (currentPlayer.currentTime / currentPlayer.duration) * 100 || 0;
            progressBar.value = percent;
            document.getElementById('curr-time').innerText = formatTime(currentPlayer.currentTime);
            document.getElementById('total-time').innerText = formatTime(currentPlayer.duration || 0);

            if (lyricsData.length > 0) {
                for (let i = 0; i < lyricsData.length; i++) {
                    if (currentPlayer.currentTime >= lyricsData[i].time) {
                        lyricLine.innerText = lyricsData[i].text;
                    } else { break; }
                }
            }
        }

        function handleEnded(e) {
            if (e.target !== currentPlayer) return;

            if (playMode === 'single') {
                currentPlayer.currentTime = 0;
                currentPlayer.play();
            } else if (playMode === 'random') {
                let randomIndex = Math.floor(Math.random() * songs.length);
                while (randomIndex === currentIndex && songs.length > 1) {
                    randomIndex = Math.floor(Math.random() * songs.length);
                }
                loadSong(randomIndex);
                playBtn.innerText = "â¸";
                currentPlayer.play();
            } else {
                nextSong();
            }
        }

        // === æ–°å¢ï¼šå¤„ç†èµ„æºåŠ è½½å¤±è´¥ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨è‡ªåŠ¨è·³è¿‡ï¼‰ ===
        function handleError(e) {
            // åªå¤„ç†å½“å‰æ’­æ”¾å™¨çš„é”™è¯¯
            if (e.target !== currentPlayer) return;

            console.log(`èµ„æºåŠ è½½å¤±è´¥: ${songs[currentIndex].title}ï¼Œå°è¯•è·³è¿‡...`);

            // æ˜¾ç¤ºæç¤º
            showToast(`âŒ æ— æ³•æ’­æ”¾: ${songs[currentIndex].title} (è‡ªåŠ¨è·³è¿‡)`);

            // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹å†åˆ‡æ­Œï¼Œé˜²æ­¢å› ä¸ºåˆ—è¡¨å…¨æŒ‚äº†å¯¼è‡´æµè§ˆå™¨å¡æ­»
            setTimeout(() => {
                // æ— è®ºä»€ä¹ˆæ¨¡å¼ï¼Œé‡åˆ°é”™è¯¯éƒ½å¼ºåˆ¶åˆ‡åˆ°ä¸‹ä¸€é¦–
                nextSong();
            }, 1000);
        }

        // === è§†é¢‘è‡ªé€‚åº”é€»è¾‘ ===
        videoEl.addEventListener('loadedmetadata', function () {
            // 1. è·å–è§†é¢‘çœŸå®çš„å®½é«˜
            const vW = this.videoWidth;
            const vH = this.videoHeight;

            // 2. è®¾å®šæœ€å¤§é™åˆ¶ (å’Œ CSS é‡Œçš„ max-width ä¿æŒä¸€è‡´)
            const maxLimit = 450;

            // 3. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ (Contain ç®—æ³•)
            const scale = Math.min(maxLimit / vW, maxLimit / vH);

            // 4. ç®—å‡ºæœ€ç»ˆæ˜¾ç¤ºçš„å®½é«˜
            const finalWidth = vW * scale;
            const finalHeight = vH * scale;

            // 5. åº”ç”¨ç»™è§†é¢‘å…ƒç´ 
            this.style.width = finalWidth + "px";
            this.style.height = finalHeight + "px";

            // 6. é¡ºä¾¿æ˜¾ç¤ºå‡ºæ¥ (é˜²æ­¢é—ªçƒ)
            if (currentPlayer === videoEl) {
                this.style.display = 'block';
            }
        });

        // ç»™ä¸¤ä¸ªæ’­æ”¾å™¨éƒ½ç»‘å®šäº‹ä»¶
        [audioEl, videoEl].forEach(player => {
            player.addEventListener('timeupdate', handleTimeUpdate);
            player.addEventListener('ended', handleEnded);
            player.addEventListener('error', handleError); // <--- æ ¸å¿ƒä¿®æ”¹ï¼šç»‘å®šé”™è¯¯ç›‘å¬
        });

        // è¿›åº¦æ¡æ‹–æ‹½
        progressBar.addEventListener('input', (e) => {
            const time = (e.target.value / 100) * currentPlayer.duration;
            currentPlayer.currentTime = time;
        });

        // 5. æ’­æ”¾åˆ—è¡¨é€»è¾‘ (å’Œä¹‹å‰ä¸€æ ·)
        function renderPlaylist(keyword = "") {
            playlistBox.innerHTML = '';
            let matchCount = 0;

            songs.forEach((song, i) => {
                const matchTitle = song.title.toLowerCase().includes(keyword.toLowerCase());
                const matchArtist = song.artist.toLowerCase().includes(keyword.toLowerCase());

                if (matchTitle || matchArtist || keyword === "") {
                    matchCount++;
                    const li = document.createElement('li');
                    // å¢åŠ ä¸€ä¸ªå°å›¾æ ‡åŒºåˆ†è§†é¢‘
                    const icon = (song.src.endsWith('.mp4')) ? "ğŸ¬ " : "";

                    li.innerHTML = `
                        <div><span class="song-idx">${i + 1}</span> ${icon}${song.title}</div>
                        <span style="font-size:12px; opacity:0.6">${song.artist}</span>
                    `;
                    if (i === currentIndex) li.classList.add('active');
                    li.onclick = () => {
                        loadSong(i);
                        playBtn.innerText = "â¸";
                        // è¿™é‡Œå°è¯•æ’­æ”¾ï¼Œå¦‚æœæœ‰é”™è¯¯ä¼šè§¦å‘ error äº‹ä»¶
                        currentPlayer.play().catch(e => { });
                    };
                    playlistBox.appendChild(li);
                }
            });

            if (matchCount === 0) {
                const li = document.createElement('li');
                li.style.flexDirection = "column";
                li.style.justifyContent = "center";
                li.style.textAlign = "center";
                li.style.background = "rgba(255,255,255,0.05)";
                li.style.padding = "20px";
                li.style.cursor = "default";
                const targetUrl = "https://www.myfreemp3.com.cn/";
                li.innerHTML = `
                    <div style="font-size:14px; opacity:0.7; margin-bottom:10px;">
                        ğŸ˜• æ²¡æ‰¾åˆ° "${keyword}"
                    </div>
                    <a href="${targetUrl}" target="_blank" 
                       style="color:#00e0ff; text-decoration:none; font-size:13px; border:1px solid #00e0ff; padding:8px 20px; border-radius:20px; display:inline-block; margin-bottom:10px; font-weight:bold;">
                       å» MyFreeMP3 æ‰¾æ­Œ ğŸ“¥
                    </a>
                `;
                playlistBox.appendChild(li);
            }
        }

        document.getElementById('playlist-search-input').addEventListener('input', (e) => {
            renderPlaylist(e.target.value);
        });

        function togglePlaylist() {
            document.getElementById('playlist-drawer').classList.toggle('open');
        }

        function formatTime(s) {
            let m = Math.floor(s / 60);
            s = Math.floor(s % 60);
            return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
        }
        function parseLyrics(lrc) {
            const lines = lrc.split('\n');
            lyricsData = [];
            lines.forEach(line => {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const t = parseInt(match[1]) * 60 + parseInt(match[2]) + parseInt(match[3]) / 100;
                    lyricsData.push({ time: t, text: match[4].trim() });
                }
            });
            lyricsData.reverse();
            if (lyricsData.length > 0) lyricLine.innerText = "æ­Œè¯åŠ è½½å®Œæˆ";
        }

        function toggleMode() {
            if (playMode === 'loop') {
                playMode = 'single';
                modeBtn.innerText = 'ğŸ”‚';
                showToast("æ¨¡å¼ï¼šå•æ›²å¾ªç¯");
            } else if (playMode === 'single') {
                playMode = 'random';
                modeBtn.innerText = 'ğŸ”€';
                showToast("æ¨¡å¼ï¼šéšæœºæ’­æ”¾");
            } else {
                playMode = 'loop';
                modeBtn.innerText = 'ğŸ”';
                showToast("æ¨¡å¼ï¼šåˆ—è¡¨å¾ªç¯");
            }
        }

        function showToast(text) {
            const toast = document.createElement('div');
            toast.innerText = text;
            toast.style.position = 'fixed';
            toast.style.bottom = '100px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'rgba(0,0,0,0.7)';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '20px';
            toast.style.zIndex = '200';
            toast.style.transition = 'opacity 0.5s';
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 1500);
        }
    </script>
</body>

</html>